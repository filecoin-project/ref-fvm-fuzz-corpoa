
























_RINvCs2zAUJC1jATr_8fvm_fuzz15stack_mutationsNCNvNvCsbRCQLiUYhjC_22instrument_with_mutate1__3run0EBM_:
   92|  1.34k|pub fn stack_mutations<'a>(
   93|  1.34k|    bin: Vec<u8>,
   94|  1.34k|    raw: &mut Unstructured<'a>,
   95|  1.34k|    mut action: impl FnMut(Vec<u8>, u64, u32, u32),
   96|  1.34k|    max_stacked_mutations: u32,
   97|  1.34k|    max_siblings_exploration: u32,
   98|  1.34k|) -> Vec<u8> {
   99|  1.34k|    let preseed: u64 = raw.arbitrary().unwrap();
  100|  1.34k|    let mut rng = SmallRng::seed_from_u64(preseed);
  101|  1.34k|    let mut cp = bin;
  102|  1.34k|
  103|  1.34k|    log::debug!("Preseed {:?}", preseed);
  104|  1.34k|    let stacked_mutations: u32 = rng.gen_range(1..max_stacked_mutations);
  105|  1.34k|    log::debug!("stacked_mutations: {}", stacked_mutations);
  106|       |
  107|  2.69k|    for i in 0..=stacked_mutations {
  108|  2.69k|        let seed = rng.gen();
  109|  2.69k|        let mut wasm_mutate = Box::<wasm_mutate::WasmMutate<'_>>::default();
  110|  2.69k|        wasm_mutate.seed(seed);
  111|  2.69k|        log::debug!("Seed: {}", seed);
  112|  2.69k|        wasm_mutate.preserve_semantics(true);
  113|  2.69k|
  114|  2.69k|        // TODO, set fuel as a parameter of the fuzzer, lets the fuzzer to determine if more fuel is needed
  115|  2.69k|        wasm_mutate.fuel(500);
  116|  2.69k|        let tomutate = cp.clone();
  117|  2.69k|        let mut_iterator = wasm_mutate.run(&tomutate);
  118|  2.69k|
  119|  2.69k|        match mut_iterator {
  120|      0|            Ok(mut it) => {
  121|      0|                // lateral traversing
  122|      0|                let check_siblings: u32 = rng.gen_range(1..max_siblings_exploration);
  123|      0|                log::debug!("check_siblings: {}", check_siblings);
  124|      0|                for j in 0..=check_siblings {
  125|      0|                    let mutated_bin = it.next();
  126|       |
  127|      0|                    if let Some(mutated_bin) = mutated_bin {
  128|      0|                        match mutated_bin {
  129|      0|                            Ok(mutated_bin) => {
  130|      0|                                action(mutated_bin.clone(), seed, i, j);
  131|      0|                                swap(&mut cp, mutated_bin);
  132|      0|                            }
  133|      0|                            Err(e) => {
  134|      0|                                // Do nothing
  135|      0|                                log::debug!("Error: {:?}", e);
  136|       |                            }
  137|       |                        }
  138|      0|                    }
  139|       |                }
  140|       |            }
  141|  2.69k|            Err(e) => {
  142|  2.69k|                // do nothing continue
  143|  2.69k|                log::debug!("Error: {:?}", e);
  144|       |            }
  145|       |        }
  146|       |    }
  147|  1.34k|    cp
  148|  1.34k|}
_RNCNvCs2zAUJC1jATr_8fvm_fuzz18get_random_fixture0B3_:
  170|   131k|        .map(|r| r.unwrap())
_RNvCs2zAUJC1jATr_8fvm_fuzz18get_random_fixture:
  165|  1.34k|pub fn get_random_fixture<'a>(raw: &mut Unstructured<'a>) -> AResult<(Vec<u8>, PathBuf)> {
  166|  1.34k|    let files = get_wasm_dir()
  167|  1.34k|        .read_dir()
  168|  1.34k|        .unwrap()
  169|  1.34k|        .into_iter()
  170|  1.34k|        .map(|r| r.unwrap())
  171|  1.34k|        .collect::<Vec<_>>();
  172|       |
  173|  1.34k|    let idx = raw.choose_index(files.len())?;
  174|  1.34k|    let random_file = files[idx].path();
  175|  1.34k|    log::debug!("Random fixture: {:?}", random_file);
  176|       |
  177|  1.34k|    let bytes = std::fs::read(&random_file)?;
  178|       |
  179|  1.34k|    Ok((bytes, random_file))
  180|  1.34k|}
_RNvCs2zAUJC1jATr_8fvm_fuzz12get_wasm_dir:
  150|  1.34k|fn get_wasm_dir() -> PathBuf {
  151|  1.34k|    match env::var("OUT") {
  152|  1.34k|        Ok(out) => {
  153|  1.34k|            let path: PathBuf = out.into();
  154|  1.34k|            path
  155|       |        }
  156|      0|        Err(e) => {
  157|      0|            log::debug!("Error {:?}", e);
  158|       |            // gracefully exit
  159|      0|            std::process::exit(0)
  160|       |        }
  161|       |    }
  162|  1.34k|}






